<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../file-input/file-input.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<!--
`firebase-upload`


@demo demo/index.html
-->

<dom-module id="firebase-upload">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-button {
        margin-left: 0;
        margin-right: 10px;
      }

      paper-spinner-lite {
        vertical-align: middle;
      }
    </style>

    <paper-button raised>
      <file-input max-files="1" on-change="_onUpload">Select a file</file-input>
    </paper-button>

    <template is="dom-if" if="[[isUploaded]]">
      [[file.name]]
    </template>

    <template is="dom-if" if="[[isUploaded]]">
      <paper-icon-button icon="close" on-tap="_onDelete"></paper-icon-button>
    </template>

    <paper-spinner-lite active=[[isLoading]]></paper-spinner-lite>
  </template>

  <script>
    Polymer({

      is: 'firebase-upload',

      properties: {
        file: {
          type: Object
        },
        isLoading: {
          type: Boolean
        },
        isUploaded: {
          type: Boolean
        }
      },

      _onUpload: function(e, detail) {
        console.log('_onUpload');
        this.file = detail.valid[0];
        this.isLoading = true;
        this.isUploaded = false;
        const uploadTask = firebase.storage().ref('test/hello').put(this.file);

        // Register three observers:
        // 1. 'state_changed' observer, called any time the state changes
        // 2. Error observer, called on failure
        // 3. Completion observer, called on successful completion
        uploadTask.on('state_changed', (snapshot) => {
          // Observe state change events such as progress, pause, and resume
          // See below for more detail
          // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          console.log('Upload is ' + progress + '% done');
        }, (error) => {
          // Handle unsuccessful uploads
          console.error(error);
          this.isLoading = false;
        }, () => {
          // Handle successful uploads on complete
          // For instance, get the download URL: https://firebasestorage.googleapis.com/...
          const downloadURL = uploadTask.snapshot.downloadURL;
          console.log('downloadURL', downloadURL);
          this.isLoading = false;
          this.isUploaded = true;
        });
      },

      _onDelete: function() {
        this.isLoading = true;

        firebase.storage().ref('test/hello').delete()
        .then(() => {
          this.file = undefined;
          this.isLoading = false;
          this.isUploaded = false;
          Polymer.dom(this.root).querySelector('file-input').reset();
        })
        .catch((err) => {
          console.error(err);
        });
      }

    });
  </script>
</dom-module>
